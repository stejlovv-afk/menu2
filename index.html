import React, { useState, useEffect, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import { ShoppingCart, Coffee, X, Trash2, ShieldCheck, Lock, ChevronRight, Search, Zap } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

// --- TYPES ---
export type Category = 'coffee' | 'tea' | 'punsh' | 'seasonal' | 'ice' | 'food' | 'drinks';

export interface MenuItem {
  id: number;
  cat: Category;
  name: string;
  price?: number;
  sizes?: Record<string, number>;
  img: string;
  noMilk?: boolean;
  noSyrup?: boolean;
  isBumble?: boolean;
}

export interface CartItem {
  uid: string;
  id: number;
  name: string;
  baseName: string;
  price: number;
  details: string;
}

export interface SelectedOptions {
  size: { label: string; price: number } | null;
  milk: string | null;
  syrup: string | null;
  temp: '–¢–µ–ø–ª—ã–π' | '–•–æ–ª–æ–¥–Ω—ã–π' | null;
  sugar: string | null;
  cinnamon: boolean;
  juice: string | null;
}

// --- CONSTANTS ---
export const IMG_BASE = "https://raw.githubusercontent.com/stejlovv-afk/menu2/main/";

export const CATEGORIES: { id: string; label: string }[] = [
  { id: 'coffee', label: '–ö–æ—Ñ–µ' },
  { id: 'tea', label: '–ß–∞–π' },
  { id: 'punsh', label: '–ü—É–Ω—à–∏' },
  { id: 'seasonal', label: '–°–µ–∑–æ–Ω' },
  { id: 'ice', label: '–•–æ–ª–æ–¥–Ω—ã–µ' },
  { id: 'food', label: '–ï–¥–∞' },
  { id: 'drinks', label: '–ù–∞–ø–∏—Ç–∫–∏' },
];

export const MILKS = ["–û–±—ã—á–Ω–æ–µ", "–ö–æ–∫–æ—Å–æ–≤–æ–µ", "–ë–∞–Ω–∞–Ω–æ–≤–æ–µ", "–ú–∏–Ω–¥–∞–ª—å–Ω–æ–µ", "–ë–µ–∑–ª–∞–∫—Ç–æ–∑–Ω–æ–µ"];
export const SYRUPS = ["–§–∏—Å—Ç–∞—à–∫–∞", "–õ–µ—Å–Ω–æ–π –æ—Ä–µ—Ö", "–ö–æ–∫–æ—Å", "–ú–∏–Ω–¥–∞–ª—å", "–õ–∞–≤–∞–Ω–¥–∞", "–ú–∞–ª–∏–Ω–∞", "–°–æ–ª–µ–Ω–∞—è –∫–∞—Ä–∞–º–µ–ª—å"];

export const MENU_ITEMS: MenuItem[] = [
    { id: 1, cat: 'coffee', name: "–ö–∞–ø—É—á–∏–Ω–æ", sizes: {"250":190, "350":230, "450":270}, img: "kapuchino-min.jpg" },
    { id: 2, cat: 'coffee', name: "–õ–∞—Ç—Ç–µ", sizes: {"250":190, "350":230, "450":270}, img: "latte-min.jpg" },
    { id: 3, cat: 'coffee', name: "–≠—Å–ø—Ä–µ—Å—Å–æ", sizes: {"30":110, "60":150}, img: "espresso1-min.jpg", noMilk: true },
    { id: 4, cat: 'coffee', name: "–ê–º–µ—Ä–∏–∫–∞–Ω–æ", sizes: {"250":180, "350":220, "450":260}, img: "americano-min.jpg", noMilk: true },
    { id: 5, cat: 'coffee', name: "–§–ª–∞—Ç –£–∞–π—Ç", sizes: {"250":220, "350":260, "450":360}, img: "kapuchino-min.jpg" },
    { id: 6, cat: 'coffee', name: "–†–∞—Ñ", sizes: {"250":210, "350":250, "450":290}, img: "latte-min.jpg" },
    { id: 7, cat: 'coffee', name: "–ë–∞–º–±–ª –¢–µ–ø–ª—ã–π", sizes: {"250":270, "350":270, "450":300}, img: "kapuchino-min.jpg", isBumble: true },
    { id: 20, cat: 'tea', name: "–ß–∞–π –ß–µ—Ä–Ω—ã–π", sizes: {"350":120, "450":180}, img: "teablack-min.jpg" },
    { id: 21, cat: 'tea', name: "–ß–∞–π –ó–µ–ª–µ–Ω—ã–π", sizes: {"350":120, "450":180}, img: "greentea-min.jpg" },
    { id: 22, cat: 'tea', name: "–ß–∞–π –ö–∞—Ä–∫–∞–¥–µ", sizes: {"350":120, "450":180}, img: "karkadetea-min.jpg" },
    { id: 23, cat: 'tea', name: "–ß–∞–π –ó–µ–ª–µ–Ω—ã–π –ñ–∞—Å–º–∏–Ω", sizes: {"350":120, "450":180}, img: "greenjasmin-min.jpg" },
    { id: 24, cat: 'tea', name: "–ß–∞–π –¢—Ä–∞–≤—è–Ω–æ–π", sizes: {"350":120, "450":180}, img: "travatea-min.jpg" },
    { id: 25, cat: 'tea', name: "–ú–∞—Ç—á–∞", sizes: {"250":180, "350":220, "450":260}, img: "matcha-min.jpg" },
    { id: 26, cat: 'tea', name: "–ö–∞–∫–∞–æ", sizes: {"250":180, "350":220, "450":260}, img: "kakao-min.jpg" },
    { id: 27, cat: 'tea', name: "–ü—Ä—è–Ω—ã–π —á–∞–π", sizes: {"250":240, "350":280, "450":320}, img: "kakao-min.jpg" },
    { id: 28, cat: 'tea', name: "–ì–æ—Ä—è—á–∏–π —à–æ–∫–æ–ª–∞–¥", price: 180, img: "kakao-min.jpg" },
    { id: 29, cat: 'tea', name: "–ì–ª–∏–Ω—Ç–≤–µ–π–Ω", sizes: {"350":230, "450":270}, img: "glintveinpunch-min.jpg" },
    { id: 50, cat: 'punsh', name: "–û–±–ª–µ–ø–∏—Ö–æ–≤—ã–π –ø—É–Ω—à", sizes: {"350":230, "450":270}, img: "oblepihapunch-min.jpg" },
    { id: 51, cat: 'punsh', name: "–ú–∞–ª–∏–Ω–æ–≤—ã–π –ø—É–Ω—à", sizes: {"350":230, "450":270}, img: "malinapunsh-min.jpg" },
    { id: 80, cat: 'seasonal', name: "–õ–∞—Ç—Ç–µ –•–∞–ª–≤–∞", sizes: {"350":290, "450":350}, img: "lattehalva-min.jpg", noSyrup: true },
    { id: 81, cat: 'seasonal', name: "–õ–∞—Ç—Ç–µ –¢—ã–∫–≤–∞", sizes: {"350":290, "450":350}, img: "lattetikva-min.jpg", noSyrup: true },
    { id: 82, cat: 'seasonal', name: "–†–∞—Ñ –°–Ω–∏–∫–µ—Ä—Å", sizes: {"350":320, "450":380}, img: "rafsnikers-min.jpg", noSyrup: true },
    { id: 83, cat: 'seasonal', name: "–õ–∞—Ç—Ç–µ Orange Christmas", sizes: {"350":320, "450":380}, img: "latteorangecristmas-min.jpg", noSyrup: true },
    { id: 60, cat: 'ice', name: "–ê–π—Å –õ–∞—Ç—Ç–µ", sizes: {"250":240, "350":280}, img: "latte-min.jpg" },
    { id: 61, cat: 'ice', name: "–≠—Å–ø—Ä–µ—Å—Å–æ –¢–æ–Ω–∏–∫", sizes: {"250":250, "350":290}, img: "granattonic-min.jpg" },
    { id: 62, cat: 'ice', name: "–ë–∞–º–±–ª –•–æ–ª–æ–¥–Ω—ã–π", sizes: {"270":270, "300":300}, img: "kapuchino-min.jpg", isBumble: true },
    { id: 63, cat: 'ice', name: "–ê–π—Å –ú–∞—Ç—á–∞", sizes: {"230":230, "270":270}, img: "matcha-min.jpg" },
    { id: 64, cat: 'ice', name: "–õ–∏–º–æ–Ω–∞–¥ (–ö–∏–≤–∏/–ú–∞–Ω–≥–æ/–°–º–æ—Ä)", sizes: {"260":260, "290":290}, img: "lemonchernogo-min.jpg" },
    { id: 100, cat: 'food', name: "Bombbar –õ–µ—Å–Ω–æ–π –æ—Ä–µ—Ö", price: 130, img: "bombbarfunduk-min.jpg" },
    { id: 101, cat: 'food', name: "Bombbar –ú–∞–ª–∏–Ω–æ–≤—ã–π", price: 130, img: "bombbarfunduk-min.jpg" },
    { id: 102, cat: 'food', name: "Bombbar –ö–æ–∫–æ—Å", price: 130, img: "bombbarfunduk-min.jpg" },
    { id: 103, cat: 'food', name: "Snaqer –û—Ä–µ—Ö/–ö–∞—Ä–∞–º–µ–ª—å", price: 130, img: "snaqerfunduk-min.jpg" },
    { id: 104, cat: 'food', name: "–ü–µ—á–µ–Ω—å–µ Chika –°–º–æ—Ä–æ–¥–∏–Ω–∞", price: 170, img: "chikabiscuitbanan-min.jpg" },
    { id: 105, cat: 'food', name: "–ü–µ—á–µ–Ω—å–µ Chika –ë–∞–Ω–∞–Ω", price: 170, img: "chikabiscuitbanan-min.jpg" },
    { id: 106, cat: 'food', name: "–ñ–≤–∞—á–∫–∞ –≠–∫–ª–∏–ø—Å", price: 80, img: "eclipce.jpg" },
    { id: 107, cat: 'food', name: "–ì–æ—Ä—å–∫–∏–π —à–æ–∫–æ–ª–∞–¥", price: 80, img: "chokolatgorkiy.jpg" },
    { id: 108, cat: 'food', name: "–ú–æ–ª–æ—á–Ω—ã–π —à–æ–∫–æ–ª–∞–¥", price: 80, img: "chokolatgorkiy.jpg" },
    { id: 109, cat: 'food', name: "Choco Pie", price: 30, img: "chudo.jpg" },
    { id: 110, cat: 'food', name: "–ë–∞—Ç–æ–Ω—á–∏–∫ –ß—É–¥–æ", price: 60, img: "chudo.jpg" },
    { id: 111, cat: 'food', name: "–ë–∞–±–∞–µ–≤—Å–∫–∏–π –±–∞—Ç–æ–Ω—á–∏–∫", price: 100, img: "babka.jpg" },
    { id: 200, cat: 'drinks', name: "–ß–µ—Ä–Ω–æ–≥–æ–ª–æ–≤–∫–∞ Cola", price: 140, img: "colachernogo-min.jpg" },
    { id: 201, cat: 'drinks', name: "–ß–µ—Ä–Ω–æ–≥–æ–ª–æ–≤–∫–∞ –ë–∞–π–∫–∞–ª", price: 140, img: "colachernogo-min.jpg" },
    { id: 202, cat: 'drinks', name: "–ß–µ—Ä–Ω–æ–≥–æ–ª–æ–≤–∫–∞ –≥–∞–∑/–Ω–µ–≥–∞–∑", price: 70, img: "negazcernogo-min.jpg" },
    { id: 203, cat: 'drinks', name: "–ß–µ—Ä–Ω–æ–≥–æ–ª–æ–≤–∫–∞ –ª–∏–º–æ–Ω–∞–¥", price: 140, img: "colachernogo-min.jpg" },
    { id: 204, cat: 'drinks', name: "Cosmos –¢—Ä–æ–ø–∏—á–µ—Å–∫–∏–π", price: 130, img: "cosmos.jpg" },
    { id: 205, cat: 'drinks', name: "Cosmos –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π", price: 130, img: "cosmos.jpg" },
    { id: 206, cat: 'drinks', name: "Adrenaline –ë–µ–∑ —Å–∞—Ö–∞—Ä–∞", price: 200, img: "adrenalin.jpg" },
    { id: 207, cat: 'drinks', name: "Adrenaline –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π", price: 200, img: "adrenalin.jpg" },
    { id: 208, cat: 'drinks', name: "–°–æ–∫ Il Primo –¢–æ–º–∞—Ç", price: 120, img: "iltomato.jpg" },
    { id: 209, cat: 'drinks', name: "–°–æ–∫ Il Primo –Ø–±–ª–æ–∫–æ", price: 120, img: "iltomato.jpg" },
    { id: 210, cat: 'drinks', name: "–°–æ–∫ Il Primo –ê–ø–µ–ª—å—Å–∏–Ω", price: 120, img: "iltomato.jpg" },
    { id: 211, cat: 'drinks', name: "Lipton –ü–µ—Ä—Å–∏–∫", price: 130, img: "lipton.jpg" },
    { id: 212, cat: 'drinks', name: "–î–∏–∫–∏–π –∞–ø–µ–ª—å—Å–∏–Ω-–Æ–¥–∑—É", price: 110, img: "chernogolovkaorange.jpg" }
];

declare global {
  interface Window {
    Telegram: {
      WebApp: any;
    };
  }
}

const tg = window.Telegram?.WebApp;

// --- COMPONENTS ---

const ModalBackdrop = ({ onClick, children }: { onClick: () => void, children: React.ReactNode }) => (
    <div className="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-0 sm:p-4">
        <motion.div 
            initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} 
            className="absolute inset-0 bg-black/30 backdrop-blur-sm" onClick={onClick} 
        />
        {children}
    </div>
);

const ProductModal = ({ item, onClose, onAdd }: { item: MenuItem; onClose: () => void; onAdd: (item: MenuItem, options: SelectedOptions, price: number) => void }) => {
  const [options, setOptions] = useState<SelectedOptions>({
    size: null, milk: null, syrup: null, temp: null, sugar: null, cinnamon: false, juice: null
  });

  const calculatePrice = () => {
    let p = item.price || (options.size ? options.size.price : 0);
    const isLarge = options.size && parseInt(options.size.label) > 300;
    if (options.milk && options.milk !== "–û–±—ã—á–Ω–æ–µ") p += isLarge ? 90 : 70;
    if (options.syrup) p += isLarge ? 50 : 30;
    return p;
  };

  const currentPrice = calculatePrice();
  const isDrinks = item.cat === 'drinks' || item.cat === 'ice';
  const canAdd = (item.sizes ? !!options.size : true) && (isDrinks ? !!options.temp : true);

  const handleAdd = () => {
    if (!canAdd) {
      tg?.HapticFeedback.notificationOccurred('error');
      if (item.sizes && !options.size) tg?.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–º!");
      else if (isDrinks && !options.temp) tg?.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É!");
      return;
    }
    tg?.HapticFeedback.impactOccurred('medium');
    onAdd(item, options, currentPrice);
  };

  return (
    <ModalBackdrop onClick={onClose}>
        <motion.div 
            initial={{ y: "100%", opacity: 0 }} animate={{ y: 0, opacity: 1 }} exit={{ y: "100%", opacity: 0 }}
            transition={{ type: "spring", damping: 25, stiffness: 300 }}
            className="relative w-full max-w-md bg-white rounded-t-[32px] sm:rounded-[32px] overflow-hidden shadow-2xl flex flex-col max-h-[92vh]"
            onClick={e => e.stopPropagation()}
        >
            <div className="relative h-56 shrink-0">
                <img src={IMG_BASE + item.img} className="w-full h-full object-cover" onError={(e) => (e.target as HTMLImageElement).src = `https://placehold.co/600?text=${item.name}`} />
                <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-60" />
                <div className="absolute bottom-0 left-0 p-6 text-white">
                    <h2 className="text-3xl font-black leading-tight shadow-sm">{item.name}</h2>
                </div>
                <button onClick={onClose} className="absolute top-4 right-4 bg-white/20 backdrop-blur-md rounded-full p-2 text-white hover:bg-white/30 transition">
                    <X size={20} />
                </button>
            </div>

            <div className="px-6 py-6 overflow-y-auto no-scrollbar flex-1 space-y-8">
                {isDrinks && (
                    <div className="space-y-3">
                        <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span>
                        <div className="grid grid-cols-2 gap-3">
                            {['–¢–µ–ø–ª—ã–π', '–•–æ–ª–æ–¥–Ω—ã–π'].map(t => (
                                <button key={t} onClick={() => setOptions({...options, temp: options.temp === t ? null : t as any})}
                                    className={`py-3.5 rounded-2xl font-bold text-sm transition-all shadow-sm ${options.temp === t ? 'bg-black text-white scale-[1.02]' : 'bg-gray-100 text-gray-600'}`}>
                                    {t === '–¢–µ–ø–ª—ã–π' ? 'üå° –¢–µ–ø–ª—ã–π' : 'üßä –•–æ–ª–æ–¥–Ω—ã–π'}
                                </button>
                            ))}
                        </div>
                    </div>
                )}

                {item.sizes && (
                    <div className="space-y-3">
                        <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">–û–±—ä–µ–º</span>
                        <div className="flex flex-wrap gap-2">
                            {Object.entries(item.sizes).map(([s, p]) => (
                                <button key={s} onClick={() => setOptions({...options, size: options.size?.label === s ? null : {label:s, price:p}})}
                                    className={`px-5 py-3 rounded-2xl font-bold text-sm transition-all border-2 ${options.size?.label === s ? 'border-black bg-black text-white' : 'border-gray-100 bg-white text-gray-700'}`}>
                                    {s} –º–ª
                                </button>
                            ))}
                        </div>
                    </div>
                )}

                {(() => {
                    const hideExtras = item.cat === 'food' || item.cat === 'drinks';
                    const showMilk = !hideExtras && !item.noMilk && item.cat !== 'tea' && item.cat !== 'punsh' && !item.isBumble;
                    const showSyrup = !hideExtras && !item.noSyrup && item.cat !== 'punsh';
                    const showJuice = item.isBumble;

                    return (
                        <>
                            {showMilk && (
                                <div className="space-y-3">
                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">–ú–æ–ª–æ–∫–æ</span>
                                    <div className="flex flex-wrap gap-2">
                                        {MILKS.map(m => (
                                            <button key={m} onClick={() => setOptions({...options, milk: options.milk === m ? null : m})}
                                                className={`px-4 py-2.5 rounded-xl text-xs font-semibold transition-all border ${options.milk === m ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-gray-200 bg-white text-gray-600'}`}>
                                                {m}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                             {showJuice && (
                                <div className="space-y-3">
                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">–°–æ–∫</span>
                                    <div className="flex gap-2">
                                        {['–ê–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π', '–í–∏—à–Ω–µ–≤—ã–π'].map(j => (
                                            <button key={j} onClick={() => setOptions({...options, juice: options.juice === j ? null : j})}
                                                className={`px-4 py-2.5 rounded-xl text-xs font-semibold transition-all border ${options.juice === j ? 'border-orange-500 bg-orange-50 text-orange-600' : 'border-gray-200 bg-white text-gray-600'}`}>
                                                {j}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {showSyrup && (
                                <div className="space-y-3">
                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">–°–∏—Ä–æ–ø</span>
                                    <div className="flex flex-wrap gap-2">
                                        {SYRUPS.map(s => (
                                            <button key={s} onClick={() => setOptions({...options, syrup: options.syrup === s ? null : s})}
                                                className={`px-4 py-2.5 rounded-xl text-xs font-semibold transition-all border ${options.syrup === s ? 'border-purple-500 bg-purple-50 text-purple-600' : 'border-gray-200 bg-white text-gray-600'}`}>
                                                {s}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {!hideExtras && (
                                <div className="space-y-3">
                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</span>
                                    <div className="flex flex-wrap gap-3 items-center">
                                        <button onClick={() => setOptions({...options, cinnamon: !options.cinnamon})}
                                            className={`px-4 py-2.5 rounded-xl text-xs font-semibold transition-all border ${options.cinnamon ? 'border-amber-500 bg-amber-50 text-amber-700' : 'border-gray-200 bg-white text-gray-600'}`}>
                                            –ö–æ—Ä–∏—Ü–∞
                                        </button>
                                        <div className="h-6 w-px bg-gray-200"></div>
                                        {['5–≥', '10–≥', '15–≥'].map(s => (
                                            <button key={s} onClick={() => setOptions({...options, sugar: options.sugar === s ? null : s})}
                                                className={`px-4 py-2.5 rounded-xl text-xs font-semibold transition-all border ${options.sugar === s ? 'border-gray-800 bg-gray-100 text-black' : 'border-gray-200 bg-white text-gray-600'}`}>
                                                –°–∞—Ö–∞—Ä {s}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </>
                    )
                })()}
                
                {/* Spacer for bottom button */}
                <div className="h-20" />
            </div>

            <div className="absolute bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-gray-200/50 p-4 pb-8 z-10">
                <button onClick={handleAdd} disabled={!canAdd} 
                    className={`w-full py-4 rounded-2xl font-bold text-lg flex justify-between px-6 transition-all shadow-lg active:scale-[0.98] ${canAdd ? 'bg-black text-white shadow-black/20' : 'bg-gray-200 text-gray-400 shadow-none'}`}>
                    <span>–î–æ–±–∞–≤–∏—Ç—å</span>
                    <span>{currentPrice} ‚ÇΩ</span>
                </button>
            </div>
        </motion.div>
    </ModalBackdrop>
  );
};

// --- APP COMPONENT ---

const App: React.FC = () => {
  const [activeCat, setActiveCat] = useState(CATEGORIES[0].id);
  const [cart, setCart] = useState<CartItem[]>([]);
  const [selectedItem, setSelectedItem] = useState<MenuItem | null>(null);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [isAdmin, setIsAdmin] = useState(false);
  const [stopList, setStopList] = useState<number[]>([]);
  
  // Checkout Form
  const [floor, setFloor] = useState('');
  const [office, setOffice] = useState('');

  // Admin Secrets
  const [tapCount, setTapCount] = useState(0);
  const tapTimer = useRef<any>(null);

  useEffect(() => {
    if (tg) {
        tg.ready();
        tg.expand();
        tg.MainButton.hide();
        tg.enableClosingConfirmation();
        const params = new URLSearchParams(window.location.search);
        const stopParam = params.get('stop');
        if (stopParam) setStopList(stopParam.split(',').map(Number));
    }
  }, []);

  const handleTitleTap = () => {
    setTapCount(prev => prev + 1);
    if (tapTimer.current) clearTimeout(tapTimer.current);
    tapTimer.current = setTimeout(() => setTapCount(0), 1000);

    if (tapCount + 1 >= 5) {
        const pwd = prompt("–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
        if (pwd === "7654") {
            setIsAdmin(true);
            tg?.showAlert("–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤–∫–ª—é—á–µ–Ω ‚úÖ");
            tg?.HapticFeedback.notificationOccurred('success');
        }
        setTapCount(0);
    }
  };

  const addToCart = (item: MenuItem, options: SelectedOptions, price: number) => {
    const detailsArr = [];
    if(options.size) detailsArr.push(`${options.size.label}–º–ª`);
    if(options.temp) detailsArr.push(options.temp);
    if(options.milk) detailsArr.push(options.milk);
    if(options.syrup) detailsArr.push(options.syrup);
    if(options.juice) detailsArr.push(options.juice);
    if(options.cinnamon) detailsArr.push("–ö–æ—Ä–∏—Ü–∞");
    if(options.sugar) detailsArr.push(`–°–∞—Ö–∞—Ä ${options.sugar}`);

    const itemDetails = detailsArr.join(', ');
    const name = `${item.name} ${options.size ? options.size.label : ''}`;

    setCart([...cart, {
        uid: Math.random().toString(36).substr(2, 9),
        id: item.id,
        baseName: item.name,
        name: name,
        price,
        details: itemDetails
    }]);
    setSelectedItem(null);
  };

  const handleCheckout = () => {
    if(!floor || !office) {
        tg?.HapticFeedback.notificationOccurred('error');
        tg?.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≠—Ç–∞–∂ –∏ –û—Ñ–∏—Å");
        return;
    }
    const payload = {
        type: 'order',
        items: cart.map(i => ({ label: i.name + (i.details ? ` (${i.details})` : ''), amount: i.price * 100 })),
        address: `–≠—Ç–∞–∂ ${floor}, –û—Ñ–∏—Å ${office}`
    };
    tg?.sendData(JSON.stringify(payload));
  };

  const handleAdminStop = (id: number) => {
    tg?.HapticFeedback.impactOccurred('medium');
    if(stopList.includes(id)) setStopList(stopList.filter(s => s !== id));
    else setStopList([...stopList, id]);
  };

  const saveAdmin = () => {
    tg?.sendData(JSON.stringify({ type: 'admin_sync', stop_list: stopList }));
  };

  return (
    <div className="min-h-screen bg-[#F2F2F7] pb-24 select-none font-sans">
      
      {/* Navbar */}
      <div className="sticky top-0 bg-white/80 backdrop-blur-xl z-40 pt-safe-top border-b border-gray-200/50">
        <div className="flex items-center justify-between px-5 h-14">
             <div onClick={handleTitleTap} className="flex flex-col cursor-pointer">
                 <h1 className="font-black text-xl tracking-tight text-black flex items-center gap-2">
                    URBAN LUNCH
                    {isAdmin && <ShieldCheck size={18} className="text-blue-500 animate-pulse"/>}
                 </h1>
                 <span className="text-[10px] font-bold text-gray-400 tracking-wide uppercase">Coffee & Food</span>
             </div>
             {cart.length > 0 && (
                 <motion.button 
                    whileTap={{ scale: 0.9 }}
                    onClick={() => setIsCartOpen(true)}
                    className="relative w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-black">
                     <ShoppingCart size={20} />
                     <span className="absolute -top-1 -right-1 bg-black text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center shadow-sm">
                         {cart.length}
                     </span>
                 </motion.button>
             )}
        </div>
        
        {/* Categories Scroller */}
        <div className="flex overflow-x-auto px-4 gap-2 pb-3 pt-1 no-scrollbar snap-x">
            {CATEGORIES.map(cat => (
                <button key={cat.id} onClick={() => { setActiveCat(cat.id); tg?.HapticFeedback.selectionChanged(); }}
                    className={`flex-none px-4 py-2 rounded-full text-[13px] font-bold transition-all snap-start ${activeCat === cat.id ? 'bg-black text-white shadow-lg shadow-black/20' : 'bg-white text-gray-500 shadow-sm border border-gray-100'}`}>
                    {cat.label}
                </button>
            ))}
        </div>
      </div>

      {/* Grid */}
      <div className="p-4 grid grid-cols-2 gap-3 sm:gap-4">
        <AnimatePresence mode="popLayout">
            {MENU_ITEMS.filter(i => i.cat === activeCat).map(item => {
                const isStopped = stopList.includes(item.id);
                if(isStopped && !isAdmin) return null;

                return (
                    <motion.div 
                        layout initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: isStopped ? 0.6 : 1, scale: 1 }} exit={{ opacity: 0, scale: 0.9 }}
                        transition={{ type: "spring", bounce: 0.2, duration: 0.6 }}
                        key={item.id}
                        onClick={() => isAdmin ? handleAdminStop(item.id) : setSelectedItem(item)}
                        className={`bg-white rounded-[24px] p-3 shadow-sm shadow-gray-200/50 flex flex-col gap-3 active:scale-[0.96] transition-transform relative border border-white ${isStopped ? 'grayscale ring-2 ring-red-500' : ''}`}
                    >
                        {isAdmin && isStopped && <div className="absolute top-3 right-3 bg-red-500 text-white p-1.5 rounded-full z-10 shadow-md"><Lock size={14}/></div>}
                        <div className="aspect-square rounded-[18px] bg-gray-50 overflow-hidden relative">
                            <img src={IMG_BASE + item.img} className="w-full h-full object-cover" loading="lazy" onError={(e) => (e.target as HTMLImageElement).src = `https://placehold.co/300?text=${item.name}`}/>
                            {!item.price && !item.sizes && <div className="absolute inset-0 flex items-center justify-center bg-gray-100 text-gray-400 text-xs">–ù–µ—Ç —Ñ–æ—Ç–æ</div>}
                        </div>
                        <div className="px-1 pb-1">
                            <div className="font-bold text-[13px] leading-tight line-clamp-2 h-8 text-gray-900">{item.name}</div>
                            <div className="flex justify-between items-end mt-2">
                                <div className="text-black font-extrabold text-sm">
                                    {item.price ? `${item.price} ‚ÇΩ` : item.sizes ? `–æ—Ç ${Object.values(item.sizes)[0]}` : ''}
                                </div>
                                <div className="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-gray-600">
                                    <ChevronRight size={14}/>
                                </div>
                            </div>
                        </div>
                    </motion.div>
                )
            })}
        </AnimatePresence>
      </div>
      
      {/* Empty State */}
      {MENU_ITEMS.filter(i => i.cat === activeCat && (!stopList.includes(i.id) || isAdmin)).length === 0 && (
          <div className="flex flex-col items-center justify-center py-20 text-gray-400 gap-4">
              <Search size={48} strokeWidth={1.5} className="opacity-20" />
              <p className="font-medium text-sm">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –ø—É—Å—Ç–æ</p>
          </div>
      )}

      {/* Admin Save Button */}
      {isAdmin && (
        <div className="fixed bottom-24 inset-x-4 z-40">
            <motion.button initial={{ y: 20, opacity: 0 }} animate={{ y: 0, opacity: 1 }}
                onClick={saveAdmin} 
                className="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-xl shadow-blue-600/30 active:scale-95 transition flex items-center justify-center gap-2 text-sm uppercase tracking-wide">
                <ShieldCheck size={18}/>
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            </motion.button>
        </div>
      )}

      {/* Modals */}
      <AnimatePresence>
        {selectedItem && <ProductModal item={selectedItem} onClose={() => setSelectedItem(null)} onAdd={addToCart} />}
      </AnimatePresence>

      <AnimatePresence>
        {isCartOpen && (
            <ModalBackdrop onClick={() => setIsCartOpen(false)}>
                <motion.div 
                    initial={{ y: "100%" }} animate={{ y: 0 }} exit={{ y: "100%" }} 
                    transition={{ type: "spring", damping: 25, stiffness: 300 }} 
                    onClick={e => e.stopPropagation()}
                    className="bg-[#F2F2F7] w-full h-[95vh] rounded-t-[32px] flex flex-col z-10 shadow-2xl overflow-hidden"
                >
                    <div className="bg-white p-5 border-b border-gray-200/50 flex justify-between items-center sticky top-0 z-10">
                        <h2 className="text-2xl font-black tracking-tight">–ö–æ—Ä–∑–∏–Ω–∞</h2>
                        {cart.length > 0 && <button onClick={() => { setCart([]); tg?.HapticFeedback.impactOccurred('medium'); }} className="text-red-500 text-xs font-bold px-3 py-1.5 bg-red-50 rounded-lg">–û—á–∏—Å—Ç–∏—Ç—å</button>}
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
                        {cart.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-full text-gray-400 gap-6 opacity-60">
                                <div className="w-24 h-24 bg-gray-200/50 rounded-full flex items-center justify-center"><ShoppingCart size={40}/></div>
                                <span className="font-bold text-lg">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</span>
                                <button onClick={() => setIsCartOpen(false)} className="text-blue-500 font-semibold">–ü–µ—Ä–µ–π—Ç–∏ –∫ –º–µ–Ω—é</button>
                            </div>
                        ) : (
                            cart.map((c, i) => (
                                <motion.div layout initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, x: -100 }} transition={{ delay: i * 0.05 }}
                                    key={c.uid} className="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-start">
                                    <div className="flex-1 pr-4">
                                        <div className="font-bold text-[15px]">{c.baseName}</div>
                                        <div className="text-xs text-gray-500 font-medium leading-relaxed mt-1 bg-gray-50 p-2 rounded-lg inline-block">
                                            {c.details || "–°—Ç–∞–Ω–¥–∞—Ä—Ç"}
                                        </div>
                                    </div>
                                    <div className="flex flex-col items-end gap-3">
                                        <span className="font-bold text-[15px]">{c.price} ‚ÇΩ</span>
                                        <button onClick={() => { setCart(cart.filter(x => x.uid !== c.uid)); tg?.HapticFeedback.selectionChanged(); }} className="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-400 hover:bg-red-50 hover:text-red-500 transition-colors">
                                            <Trash2 size={16}/>
                                        </button>
                                    </div>
                                </motion.div>
                            ))
                        )}
                    </div>

                    {cart.length > 0 && (
                        <div className="p-5 bg-white border-t border-gray-200 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] pb-safe-bottom">
                            <div className="space-y-3 mb-5">
                                <div className="relative">
                                    <input type="number" placeholder="–≠—Ç–∞–∂" value={floor} onChange={e=>setFloor(e.target.value)} 
                                        className="w-full p-4 pl-12 rounded-xl bg-gray-50 border-none font-semibold focus:ring-2 ring-black transition-all outline-none"/>
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xs uppercase">Fl.</div>
                                </div>
                                <div className="relative">
                                    <input type="text" placeholder="–û—Ñ–∏—Å / –ö–∞–±–∏–Ω–µ—Ç" value={office} onChange={e=>setOffice(e.target.value)} 
                                        className="w-full p-4 pl-12 rounded-xl bg-gray-50 border-none font-semibold focus:ring-2 ring-black transition-all outline-none"/>
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xs uppercase">Of.</div>
                                </div>
                            </div>
                            <button onClick={handleCheckout} className="w-full bg-black text-white font-bold py-4 rounded-2xl flex justify-between px-6 shadow-xl shadow-black/10 active:scale-[0.98] transition">
                                <span>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</span>
                                <span>{cart.reduce((a,b)=>a+b.price,0)} ‚ÇΩ</span>
                            </button>
                        </div>
                    )}
                </motion.div>
            </ModalBackdrop>
        )}
      </AnimatePresence>

    </div>
  );
};

const rootElement = document.getElementById('root');
if (rootElement) {
  createRoot(rootElement).render(<App />);
}
